<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CISM 2024: Assessment Interactive - Designer Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Global Styles & Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --dark-navy-bg: #0a101f;
            --surface-color: #10192b;
            --accent-glow: #00bfff; /* Deep Sky Blue */
            --accent-hover: #ffffff;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #2d3748;
            --shadow-color: rgba(0, 191, 255, 0.1);
            --success-bg: rgba(40, 167, 69, 0.1);
            --success-border: #28a745;
            --danger-bg: rgba(220, 53, 69, 0.1);
            --danger-border: #dc3545;
            --transition-fast: all 0.3s ease-in-out;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-navy-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
        }

        /* Header */
        header {
            background: linear-gradient(180deg, var(--surface-color), var(--dark-navy-bg));
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Main Content Area */
        #assessment-container {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Tabs for Domain Selection */
        .assessment-tab {
            border: 2px solid transparent;
            border-radius: 0.5rem;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .assessment-tab:not(.active):hover {
            border-color: var(--accent-glow);
            background-color: rgba(0, 191, 255, 0.05);
        }
        .assessment-tab.active {
            background-color: var(--accent-glow);
            color: var(--dark-navy-bg);
            font-weight: 700;
            box-shadow: 0 0 20px var(--shadow-color);
        }

        /* Fade-in Animation */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards for Quiz Options */
        .assessment-card {
            background: rgba(10, 16, 31, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            transition: var(--transition-fast);
        }
        .assessment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: var(--accent-glow);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: var(--transition-fast);
            cursor: pointer;
            text-decoration: none;
            border: none;
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-primary {
            background-color: var(--accent-glow);
            color: var(--dark-navy-bg);
            box-shadow: 0 0 15px var(--shadow-color);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-hover);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.3);
        }
        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #4a5568;
        }
        .btn-danger {
            background-color: var(--danger-border);
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
        }

        /* Answer Options in Quiz */
        .answer-option {
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .answer-option:hover {
            border-color: var(--accent-glow);
            background-color: rgba(0, 191, 255, 0.1);
        }
        .answer-option.selected {
            background-color: rgba(0, 191, 255, 0.2);
            border-color: var(--accent-glow);
            color: var(--accent-glow);
        }
        .answer-option.correct {
            background-color: var(--success-bg);
            border-color: var(--success-border);
            color: #81c784;
        }
        .answer-option.incorrect {
            background-color: var(--danger-bg);
            border-color: var(--danger-border);
            color: #e57373;
        }

        /* Progress Bar */
        .progress-bar-container {
            background-color: var(--dark-navy-bg);
            border-radius: 9999px;
            height: 12px;
            width: 100%;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .progress-bar {
            background: linear-gradient(90deg, #00bfff, #1e90ff);
            height: 100%;
            transition: width 0.4s ease-in-out;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 2.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        /* Custom Number Input */
        .custom-number-input {
            width: 80px;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: var(--dark-navy-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .custom-number-input:focus {
            outline: none;
            border-color: var(--accent-glow);
            box-shadow: 0 0 10px var(--shadow-color);
        }
        
        /* Results Breakdown Styling */
        #results-breakdown .breakdown-item {
            background-color: var(--dark-navy-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body class="leading-relaxed">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center py-10 mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2 tracking-tighter">CISM Assessment Center</h1>
            <p class="text-xl sm:text-2xl text-gray-400">Test Your Knowledge and Prepare for the Exam</p>
        </header>

        <main id="assessment-container" class="p-4 sm:p-6 lg:p-8">
            <!-- Assessment Setup View -->
            <div id="assessment-setup">
                <nav class="p-2 rounded-lg mb-8 flex flex-wrap justify-center sticky top-0 z-10 gap-2 sm:gap-4 bg-black/20 backdrop-blur-sm border border-gray-700/50">
                    <button class="assessment-tab px-4 py-2 text-lg font-medium text-gray-300 active" data-target="domain-1">Domain 1</button>
                    <button class="assessment-tab px-4 py-2 text-lg font-medium text-gray-300" data-target="domain-2">Domain 2</button>
                    <button class="assessment-tab px-4 py-2 text-lg font-medium text-gray-300" data-target="domain-3">Domain 3</button>
                    <button class="assessment-tab px-4 py-2 text-lg font-medium text-gray-300" data-target="domain-4">Domain 4</button>
                    <button class="assessment-tab px-4 py-2 text-lg font-medium text-gray-300" data-target="simulated-exam">Simulated Exam</button>
                </nav>
                <div id="assessment-options-area" class="fade-in"></div>
            </div>

            <!-- Assessment In-Progress View -->
            <div id="assessment-in-progress" class="hidden">
                <div class="p-6 sm:p-8 rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="question-counter" class="text-xl font-bold text-gray-200"></h2>
                        <div id="timer-display" class="text-xl font-bold text-accent-glow hidden">4:00:00</div>
                        <button id="quit-assessment-btn" class="btn btn-secondary text-sm px-3 py-1">Quit</button>
                    </div>
                    <div class="progress-bar-container mb-8">
                        <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p id="question-text" class="text-xl text-gray-300 mb-8 leading-relaxed"></p>
                    <div id="answer-options" class="space-y-4"></div>
                    <div class="flex justify-between mt-10">
                        <button id="prev-question-btn" class="btn btn-secondary">Previous</button>
                        <button id="next-question-btn" class="btn btn-primary">Next</button>
                        <button id="submit-assessment-btn" class="btn btn-primary hidden">Submit Assessment</button>
                    </div>
                </div>
            </div>

            <!-- Assessment Results View -->
            <div id="assessment-results" class="hidden">
                <div class="p-6 sm:p-8 rounded-lg text-center">
                    <h2 class="text-4xl font-bold text-white mb-4 inline-block">Assessment Complete!</h2>
                    <p class="text-xl text-gray-400 mb-4">Here's how you did:</p>
                    <p id="final-score" class="text-7xl font-extrabold text-accent-glow my-6"></p>
                    <p id="score-details" class="text-lg text-gray-300 mb-8"></p>
                    <div id="results-breakdown" class="mb-10 text-left max-w-lg mx-auto space-y-3"></div>
                    <div class="flex justify-center gap-4">
                        <button id="review-answers-btn" class="btn btn-secondary">Review Answers</button>
                        <button id="restart-assessment-btn" class="btn btn-primary">Try Again</button>
                    </div>
                </div>
            </div>
            
            <!-- Assessment Review View -->
            <div id="assessment-review" class="hidden"></div>
        </main>

        <footer class="text-center py-6 mt-8 text-gray-500 text-sm">
            <p>&copy; 2024 CISM Study Guide. All rights reserved. For educational purposes only.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="quit-modal" class="modal-overlay hidden">
        <div class="modal-content fade-in">
            <h3 class="text-2xl font-bold mb-4 text-white">Are you sure?</h3>
            <p class="text-gray-400 mb-8">Your progress on this assessment will be lost.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-quit-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-quit-btn" class="btn btn-danger">Yes, Quit</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay hidden">
        <div class="modal-content fade-in">
            <h3 id="alert-title" class="text-2xl font-bold mb-4 text-white">Notice</h3>
            <p id="alert-message" class="text-gray-400 mb-8"></p>
            <div class="flex justify-center">
                <button id="confirm-alert-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_MODEL = 'gemini-2.5-flash-preview-05-20';
        const API_KEY = ''; // Leave empty, will be handled by the environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;

        const domainWeights = { 'domain-1': 0.17, 'domain-2': 0.20, 'domain-3': 0.33, 'domain-4': 0.30 };
        const domainDetails = {
            'domain-1': { title: "Information Security Governance", weight: 17, maxQuestions: 30 },
            'domain-2': { title: "Information Security Risk Management", weight: 20, maxQuestions: 30 },
            'domain-3': { title: "Information Security Program", weight: 33, maxQuestions: 50 },
            'domain-4': { title: "Incident Management", weight: 30, maxQuestions: 45 },
            'simulated-exam': { title: "Simulated Exam", totalQuestions: 150 }
        };

        let currentAssessment = { questions: [], userAnswers: [], currentQuestionIndex: 0, startTime: null, assessmentType: null, timerInterval: null };

        // --- DOM Element References ---
        const setupView = document.getElementById('assessment-setup');
        const inProgressView = document.getElementById('assessment-in-progress');
        const resultsView = document.getElementById('assessment-results');
        const reviewView = document.getElementById('assessment-review');
        const optionsArea = document.getElementById('assessment-options-area');
        const tabs = document.querySelectorAll('.assessment-tab');
        const questionCounter = document.getElementById('question-counter');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const prevBtn = document.getElementById('prev-question-btn');
        const nextBtn = document.getElementById('next-question-btn');
        const submitBtn = document.getElementById('submit-assessment-btn');
        const quitBtn = document.getElementById('quit-assessment-btn');
        const timerDisplay = document.getElementById('timer-display');
        const finalScoreEl = document.getElementById('final-score');
        const scoreDetailsEl = document.getElementById('score-details');
        const resultsBreakdownEl = document.getElementById('results-breakdown');
        const reviewAnswersBtn = document.getElementById('review-answers-btn');
        const restartAssessmentBtn = document.getElementById('restart-assessment-btn');
        const quitModal = document.getElementById('quit-modal');
        const confirmQuitBtn = document.getElementById('confirm-quit-btn');
        const cancelQuitBtn = document.getElementById('cancel-quit-btn');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const confirmAlertBtn = document.getElementById('confirm-alert-btn');
        
        function showCustomAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        function showView(viewToShow) {
            [setupView, inProgressView, resultsView, reviewView].forEach(v => v.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
            viewToShow.classList.add('fade-in');
        }

        function renderOptions(target) {
            const details = domainDetails[target];
            const maxQuestions = details.maxQuestions || 0;
            let content = '';

            if (target === 'simulated-exam') {
                const d1q = Math.round(details.totalQuestions * domainWeights['domain-1']);
                const d2q = Math.round(details.totalQuestions * domainWeights['domain-2']);
                const d3q = Math.round(details.totalQuestions * domainWeights['domain-3']);
                const d4q = details.totalQuestions - d1q - d2q - d3q;

                content = `
                    <div class="assessment-card p-6 sm:p-8 text-center">
                        <h3 class="text-2xl font-bold text-white mb-2">${details.title}</h3>
                        <p class="text-gray-400 mb-6">This is a full-length simulated exam with ${details.totalQuestions} questions, weighted according to the official CISM exam outline.</p>
                        <ul class="text-left max-w-sm mx-auto list-disc list-inside mb-8 text-gray-400">
                            <li>Domain 1: ${d1q} questions</li>
                            <li>Domain 2: ${d2q} questions</li>
                            <li>Domain 3: ${d3q} questions</li>
                            <li>Domain 4: ${d4q} questions</li>
                        </ul>
                        <button class="btn btn-primary start-assessment-btn" data-type="simulated">
                            <span class="btn-text">Start Simulated Exam</span>
                            <span class="btn-loader hidden animate-pulse">Generating Exam...</span>
                        </button>
                    </div>`;
            } else {
                const weightedQuestions = Math.round(150 * domainWeights[target]);
                content = `
                    <div class="assessment-card p-6 sm:p-8 text-center">
                        <h3 class="text-2xl font-bold text-white mb-2">Domain: ${details.title}</h3>
                        <p class="text-gray-400 mb-8">Choose how you want to test your knowledge for this domain.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="p-6 bg-black/20 rounded-lg flex flex-col justify-between border border-gray-700">
                                <div>
                                    <h4 class="text-xl font-semibold mb-3 text-gray-200">Practice Quiz</h4>
                                    <p class="text-sm text-gray-400 mb-4">Enter the number of questions you want to practice (max ${maxQuestions}).</p>
                                    <input type="number" id="custom-question-count" class="custom-number-input mb-4" value="${maxQuestions}" min="1" max="${maxQuestions}">
                                </div>
                                <button class="btn btn-primary start-assessment-btn mt-4" data-type="custom" data-domain="${target}">
                                    <span class="btn-text">Start Practice</span>
                                    <span class="btn-loader hidden animate-pulse">Generating...</span>
                                </button>
                            </div>
                            <div class="p-6 bg-black/20 rounded-lg flex flex-col justify-between border border-gray-700">
                                <div>
                                    <h4 class="text-xl font-semibold mb-3 text-gray-200">Weighted Quiz</h4>
                                    <p class="text-sm text-gray-400 mb-4">Take a quiz weighted like the real exam (${details.weight}% of 150 questions).</p>
                                    <p class="text-4xl font-bold text-accent-glow mb-4">${weightedQuestions} Questions</p>
                                </div>
                                <button class="btn btn-primary start-assessment-btn" data-type="weighted" data-domain="${target}" data-count="${weightedQuestions}">
                                    <span class="btn-text">Start Weighted Quiz</span>
                                    <span class="btn-loader hidden animate-pulse">Generating...</span>
                                </button>
                            </div>
                        </div>
                    </div>`;
            }
            optionsArea.innerHTML = content;
        }
        
        async function fetchWithBackoff(url, payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) return response.json();
                } catch (error) {
                    // Network or other fetch-related errors
                    if (i === retries - 1) throw error;
                }
                await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
            }
            throw new Error('API request failed after multiple retries.');
        }

        async function generateQuestionsWithGemini(domain, count) {
            const systemPrompt = "You are an expert CISM (Certified Information Security Manager) exam content creator. Generate realistic, high-quality multiple-choice questions. Each question must have exactly four answer options, with one clear correct answer and three plausible but incorrect distractors. The 'correct' field must be the zero-based index of the correct answer. Provide a concise but thorough explanation for why the correct answer is right.";
            const userQuery = `Generate ${count} unique CISM exam practice questions for CISM Domain: "${domainDetails[domain].title}".`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING" },
                                answers: { type: "ARRAY", items: { type: "STRING" } },
                                correct: { type: "NUMBER" },
                                explanation: { type: "STRING" }
                            },
                            required: ["question", "answers", "correct", "explanation"]
                        }
                    }
                }
            };
            
            const result = await fetchWithBackoff(API_URL, payload);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Invalid response structure from API.");
            
            return JSON.parse(text);
        }

        async function getQuestionsForAssessment(type, domain, count) {
            if (type === 'simulated') {
                const d1q = Math.round(150 * domainWeights['domain-1']);
                const d2q = Math.round(150 * domainWeights['domain-2']);
                const d3q = Math.round(150 * domainWeights['domain-3']);
                const d4q = 150 - d1q - d2q - d3q;
                
                const questionPromises = [
                    generateQuestionsWithGemini('domain-1', d1q),
                    generateQuestionsWithGemini('domain-2', d2q),
                    generateQuestionsWithGemini('domain-3', d3q),
                    generateQuestionsWithGemini('domain-4', d4q),
                ];

                const results = await Promise.all(questionPromises);
                
                let allQuestions = [];
                results.forEach((domainQuestions, index) => {
                    const domainKey = `domain-${index + 1}`;
                    const questionsWithDomain = domainQuestions.map(q => ({ ...q, domain: domainKey }));
                    allQuestions = allQuestions.concat(questionsWithDomain);
                });
                
                return allQuestions.sort(() => 0.5 - Math.random()); // Shuffle the final list
            } else {
                const questions = await generateQuestionsWithGemini(domain, count);
                return questions.map(q => ({...q, domain}));
            }
        }

        function handleTabClick(e) {
            tabs.forEach(tab => tab.classList.remove('active'));
            e.target.classList.add('active');
            renderOptions(e.target.dataset.target);
        }

        function stopTimer() {
            if (currentAssessment.timerInterval) clearInterval(currentAssessment.timerInterval);
            currentAssessment.timerInterval = null;
            timerDisplay.classList.add('hidden');
        }

        function startTimer() {
            stopTimer();
            const duration = 4 * 60 * 60 * 1000;
            const endTime = new Date().getTime() + duration;
            timerDisplay.classList.remove('hidden');
            currentAssessment.timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;
                if (distance < 0) {
                    stopTimer();
                    timerDisplay.textContent = "0:00:00";
                    submitAssessment();
                    return;
                }
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerDisplay.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function startAssessment(questions, type) {
            currentAssessment = { ...currentAssessment, questions, userAnswers: new Array(questions.length).fill(null), currentQuestionIndex: 0, startTime: new Date(), assessmentType: type };
            if (type === 'simulated') startTimer(); else stopTimer();
            displayQuestion();
            showView(inProgressView);
        }

        function displayQuestion() {
            const q = currentAssessment.questions[currentAssessment.currentQuestionIndex];
            const qNum = currentAssessment.currentQuestionIndex + 1;
            const total = currentAssessment.questions.length;
            questionCounter.textContent = `Question ${qNum} of ${total}`;
            progressBar.style.width = `${(qNum / total) * 100}%`;
            questionText.textContent = q.question;
            answerOptionsContainer.innerHTML = q.answers.map((answer, index) => {
                const isSelected = currentAssessment.userAnswers[currentAssessment.currentQuestionIndex] === index;
                return `<div class="answer-option ${isSelected ? 'selected' : ''}" data-index="${index}">${answer}</div>`;
            }).join('');
            answerOptionsContainer.querySelectorAll('.answer-option').forEach(opt => opt.addEventListener('click', () => selectAnswer(parseInt(opt.dataset.index))));
            prevBtn.classList.toggle('hidden', currentAssessment.currentQuestionIndex === 0);
            nextBtn.classList.toggle('hidden', qNum === total);
            submitBtn.classList.toggle('hidden', qNum !== total);
        }

        function selectAnswer(index) {
            currentAssessment.userAnswers[currentAssessment.currentQuestionIndex] = index;
            displayQuestion();
        }

        function changeQuestion(direction) {
            currentAssessment.currentQuestionIndex += direction;
            displayQuestion();
        }

        function submitAssessment() {
            stopTimer();
            let correctCount = 0;
            let breakdown = {};
            currentAssessment.questions.forEach((q, index) => {
                const domain = q.domain || 'domain';
                if (!breakdown[domain]) breakdown[domain] = { correct: 0, total: 0 };
                breakdown[domain].total++;
                if (currentAssessment.userAnswers[index] === q.correct) {
                    correctCount++;
                    breakdown[domain].correct++;
                }
            });
            const totalQuestions = currentAssessment.questions.length;
            const score = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
            finalScoreEl.textContent = `${score}%`;
            scoreDetailsEl.textContent = `You answered ${correctCount} out of ${totalQuestions} questions correctly.`;
            resultsBreakdownEl.innerHTML = Object.keys(breakdown).map(domainKey => {
                const domainData = breakdown[domainKey];
                const domainScore = domainData.total > 0 ? Math.round((domainData.correct / domainData.total) * 100) : 0;
                const title = domainDetails[domainKey]?.title || 'Overall';
                return `<div class="flex justify-between items-center breakdown-item">
                    <span class="text-gray-300">Domain: ${title}</span>
                    <span class="font-bold text-white">${domainScore}% (${domainData.correct}/${domainData.total})</span>
                </div>`;
            }).join('');
            showView(resultsView);
        }
        
        function reviewAnswers() {
            reviewView.innerHTML = `<div class="p-6 sm:p-8 rounded-lg">
                <h2 class="text-3xl font-bold text-white mb-8">Review Answers</h2>
                ${currentAssessment.questions.map((q, index) => {
                    const userAnswer = currentAssessment.userAnswers[index];
                    return `<div class="mb-8 pb-6 border-b border-gray-700">
                        <p class="font-bold text-gray-200 mb-4">Question ${index + 1}: ${q.question}</p>
                        <div class="space-y-3">${q.answers.map((answer, ansIndex) => {
                            let classes = 'answer-option p-3';
                            if (ansIndex === q.correct) classes += ' correct';
                            else if (ansIndex === userAnswer) classes += ' incorrect';
                            return `<div class="${classes}">${answer}</div>`;
                        }).join('')}</div>
                        <div class="mt-4 p-3 rounded-md bg-black/20 border border-gray-700">
                            <strong class="text-accent-glow">Explanation:</strong>
                            <p class="text-gray-400 mt-1">${q.explanation}</p>
                        </div>
                    </div>`;
                }).join('')}
                <div class="text-center mt-8"><button id="back-to-results-btn" class="btn btn-primary">Back to Results</button></div>
            </div>`;
            showView(reviewView);
            document.getElementById('back-to-results-btn').addEventListener('click', () => showView(resultsView));
        }

        // --- Event Listeners ---
        tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
        
        optionsArea.addEventListener('click', async (e) => {
            const button = e.target.closest('.start-assessment-btn');
            if (!button) return;

            const btnText = button.querySelector('.btn-text');
            const btnLoader = button.querySelector('.btn-loader');
            const originalBtnText = btnText.textContent;

            try {
                button.disabled = true;
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');

                const { type, domain } = button.dataset;
                let count = parseInt(button.dataset.count);

                if (type === 'custom') {
                    const countInput = document.getElementById('custom-question-count');
                    const max = parseInt(countInput.max);
                    const val = parseInt(countInput.value);
                    if (val > 0 && val <= max) {
                        count = val;
                    } else {
                        throw new Error(`Please enter a number between 1 and ${max}.`);
                    }
                }

                const questions = await getQuestionsForAssessment(type, domain, count);
                if (questions && questions.length > 0) {
                    startAssessment(questions, type);
                } else {
                    throw new Error('Failed to generate questions. Please try again.');
                }
            } catch (error) {
                console.error("Error starting assessment:", error);
                showCustomAlert('Generation Failed', error.message || 'Could not generate questions from the API. Please check the console and try again.');
            } finally {
                button.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        });

        nextBtn.addEventListener('click', () => changeQuestion(1));
        prevBtn.addEventListener('click', () => changeQuestion(-1));
        submitBtn.addEventListener('click', submitAssessment);
        quitBtn.addEventListener('click', () => quitModal.classList.remove('hidden'));
        cancelQuitBtn.addEventListener('click', () => quitModal.classList.add('hidden'));
        confirmQuitBtn.addEventListener('click', () => {
            stopTimer();
            quitModal.classList.add('hidden');
            showView(setupView);
            renderOptions(document.querySelector('.assessment-tab.active').dataset.target);
        });
        reviewAnswersBtn.addEventListener('click', reviewAnswers);
        restartAssessmentBtn.addEventListener('click', () => {
            // Re-render setup to allow choosing a new quiz
            showView(setupView);
            renderOptions(document.querySelector('.assessment-tab.active').dataset.target);
        });
        confirmAlertBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

        // --- Initial Load ---
        renderOptions('domain-1');
    });
    </script>
</body>
</html>

